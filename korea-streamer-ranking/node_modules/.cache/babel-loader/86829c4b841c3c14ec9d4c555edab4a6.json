{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.PipeTransport = void 0;\n/**\n * Copyright 2018 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nconst helper_js_1 = require(\"../common/helper.js\");\n\nclass PipeTransport {\n  constructor(pipeWrite, pipeRead) {\n    this._pipeWrite = pipeWrite;\n    this._pendingMessage = '';\n    this._eventListeners = [helper_js_1.helper.addEventListener(pipeRead, 'data', buffer => this._dispatch(buffer)), helper_js_1.helper.addEventListener(pipeRead, 'close', () => {\n      if (this.onclose) this.onclose.call(null);\n    }), helper_js_1.helper.addEventListener(pipeRead, 'error', helper_js_1.debugError), helper_js_1.helper.addEventListener(pipeWrite, 'error', helper_js_1.debugError)];\n    this.onmessage = null;\n    this.onclose = null;\n  }\n\n  send(message) {\n    this._pipeWrite.write(message);\n\n    this._pipeWrite.write('\\0');\n  }\n\n  _dispatch(buffer) {\n    let end = buffer.indexOf('\\0');\n\n    if (end === -1) {\n      this._pendingMessage += buffer.toString();\n      return;\n    }\n\n    const message = this._pendingMessage + buffer.toString(undefined, 0, end);\n    if (this.onmessage) this.onmessage.call(null, message);\n    let start = end + 1;\n    end = buffer.indexOf('\\0', start);\n\n    while (end !== -1) {\n      if (this.onmessage) this.onmessage.call(null, buffer.toString(undefined, start, end));\n      start = end + 1;\n      end = buffer.indexOf('\\0', start);\n    }\n\n    this._pendingMessage = buffer.toString(undefined, start);\n  }\n\n  close() {\n    this._pipeWrite = null;\n    helper_js_1.helper.removeEventListeners(this._eventListeners);\n  }\n\n}\n\nexports.PipeTransport = PipeTransport;","map":{"version":3,"mappings":";;;;;;AAAA;;;;;;;;;;;;;;;;AAeA;;AAOA,MAAaA,aAAb,CAA0B;EAQxBC,YACEC,SADF,EAEEC,QAFF,EAEiC;IAE/B,KAAKC,UAAL,GAAkBF,SAAlB;IACA,KAAKG,eAAL,GAAuB,EAAvB;IACA,KAAKC,eAAL,GAAuB,CACrBC,mBAAOC,gBAAP,CAAwBL,QAAxB,EAAkC,MAAlC,EAA2CM,MAAD,IACxC,KAAKC,SAAL,CAAeD,MAAf,CADF,CADqB,EAIrBF,mBAAOC,gBAAP,CAAwBL,QAAxB,EAAkC,OAAlC,EAA2C,MAAK;MAC9C,IAAI,KAAKQ,OAAT,EAAkB,KAAKA,OAAL,CAAaC,IAAb,CAAkB,IAAlB;IACnB,CAFD,CAJqB,EAOrBL,mBAAOC,gBAAP,CAAwBL,QAAxB,EAAkC,OAAlC,EAA2CI,sBAA3C,CAPqB,EAQrBA,mBAAOC,gBAAP,CAAwBN,SAAxB,EAAmC,OAAnC,EAA4CK,sBAA5C,CARqB,CAAvB;IAUA,KAAKM,SAAL,GAAiB,IAAjB;IACA,KAAKF,OAAL,GAAe,IAAf;EACD;;EAEDG,IAAI,CAACC,OAAD,EAAgB;IAClB,KAAKX,UAAL,CAAgBY,KAAhB,CAAsBD,OAAtB;;IACA,KAAKX,UAAL,CAAgBY,KAAhB,CAAsB,IAAtB;EACD;;EAEDN,SAAS,CAACD,MAAD,EAAe;IACtB,IAAIQ,GAAG,GAAGR,MAAM,CAACS,OAAP,CAAe,IAAf,CAAV;;IACA,IAAID,GAAG,KAAK,CAAC,CAAb,EAAgB;MACd,KAAKZ,eAAL,IAAwBI,MAAM,CAACU,QAAP,EAAxB;MACA;IACD;;IACD,MAAMJ,OAAO,GAAG,KAAKV,eAAL,GAAuBI,MAAM,CAACU,QAAP,CAAgBC,SAAhB,EAA2B,CAA3B,EAA8BH,GAA9B,CAAvC;IACA,IAAI,KAAKJ,SAAT,EAAoB,KAAKA,SAAL,CAAeD,IAAf,CAAoB,IAApB,EAA0BG,OAA1B;IAEpB,IAAIM,KAAK,GAAGJ,GAAG,GAAG,CAAlB;IACAA,GAAG,GAAGR,MAAM,CAACS,OAAP,CAAe,IAAf,EAAqBG,KAArB,CAAN;;IACA,OAAOJ,GAAG,KAAK,CAAC,CAAhB,EAAmB;MACjB,IAAI,KAAKJ,SAAT,EACE,KAAKA,SAAL,CAAeD,IAAf,CAAoB,IAApB,EAA0BH,MAAM,CAACU,QAAP,CAAgBC,SAAhB,EAA2BC,KAA3B,EAAkCJ,GAAlC,CAA1B;MACFI,KAAK,GAAGJ,GAAG,GAAG,CAAd;MACAA,GAAG,GAAGR,MAAM,CAACS,OAAP,CAAe,IAAf,EAAqBG,KAArB,CAAN;IACD;;IACD,KAAKhB,eAAL,GAAuBI,MAAM,CAACU,QAAP,CAAgBC,SAAhB,EAA2BC,KAA3B,CAAvB;EACD;;EAEDC,KAAK;IACH,KAAKlB,UAAL,GAAkB,IAAlB;IACAG,mBAAOgB,oBAAP,CAA4B,KAAKjB,eAAjC;EACD;;AAxDuB;;AAA1BkB","names":["PipeTransport","constructor","pipeWrite","pipeRead","_pipeWrite","_pendingMessage","_eventListeners","helper_js_1","addEventListener","buffer","_dispatch","onclose","call","onmessage","send","message","write","end","indexOf","toString","undefined","start","close","removeEventListeners","exports"],"sources":["../../../../src/node/PipeTransport.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}